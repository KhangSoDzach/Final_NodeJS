<div class="product-listing">
    <div class="page-header">
        <h1>Sản phẩm</h1>
        <p>Tìm thấy <%= totalProducts %> sản phẩm</p>
    </div>
    
    <!-- Active Filters Bar -->
    <% 
    const activeFilters = [];
    if (filter.search) activeFilters.push({ type: 'search', label: 'Tìm kiếm: ' + filter.search, value: filter.search });
    if (filter.category) activeFilters.push({ type: 'category', label: 'Danh mục: ' + filter.category, value: filter.category });
    if (filter.subcategory) activeFilters.push({ type: 'subcategory', label: 'Phụ mục: ' + filter.subcategory, value: filter.subcategory });
    if (filter.brand) {
      const brands = Array.isArray(filter.brand) ? filter.brand : [filter.brand];
      brands.forEach(b => activeFilters.push({ type: 'brand', label: 'Thương hiệu: ' + b, value: b }));
    }
    if (filter.minPrice || filter.maxPrice) {
      let priceLabel = 'Giá: ';
      if (filter.minPrice) priceLabel += parseInt(filter.minPrice).toLocaleString('vi-VN') + '₫';
      priceLabel += ' - ';
      if (filter.maxPrice) priceLabel += parseInt(filter.maxPrice).toLocaleString('vi-VN') + '₫';
      activeFilters.push({ type: 'price', label: priceLabel, value: 'price' });
    }
    if (filter.rating) activeFilters.push({ type: 'rating', label: filter.rating + ' sao trở lên', value: filter.rating });
    if (filter.stock) {
      const stockLabels = { 'in-stock': 'Còn hàng', 'out-of-stock': 'Hết hàng', 'pre-order': 'Đặt trước' };
      activeFilters.push({ type: 'stock', label: stockLabels[filter.stock] || filter.stock, value: filter.stock });
    }
    if (filter.discount === 'has-discount') activeFilters.push({ type: 'discount', label: 'Đang giảm giá', value: filter.discount });
    %>
    
    <% if (activeFilters.length > 0) { %>
    <div class="active-filters-bar">
        <span class="label"><i class="fas fa-filter"></i> Đang lọc:</span>
        <% activeFilters.forEach(af => { %>
            <span class="active-filter-tag" data-type="<%= af.type %>" data-value="<%= af.value %>">
                <%= af.label %>
                <i class="fas fa-times remove-filter"></i>
            </span>
        <% }) %>
        <span class="clear-all-filters" onclick="window.location.href='/products'">
            <i class="fas fa-trash-alt"></i> Xóa tất cả
        </span>
    </div>
    <% } %>
    
    <!-- Mobile Filter Button -->
    <button class="mobile-filter-btn" id="mobileFilterBtn">
        <i class="fas fa-sliders-h"></i> Bộ lọc nâng cao
    </button>
    
    <div class="product-container">
        <!-- Sidebar filters -->
        <div class="product-filters" id="filtersSidebar">
            <form action="/products" method="GET" id="filterForm">
                <!-- Hidden inputs for maintaining pagination and sort -->
                <% if(filter.page) { %>
                    <input type="hidden" name="page" value="<%= filter.page %>">
                <% } %>
                <% if(filter.sort) { %>
                    <input type="hidden" name="sort" value="<%= filter.sort %>">
                <% } %>
                <% if(filter.search) { %>
                    <input type="hidden" name="search" value="<%= filter.search %>">
                <% } %>
                
                <div class="filter-section">
                    <h3><i class="fas fa-folder"></i> Danh mục</h3>
                    <div class="filter-options">
                        <% categories.forEach(category => { %>
                            <div class="filter-option">
                                <input type="radio" name="category" id="cat-<%= category %>" 
                                    value="<%= category %>" 
                                    <%= filter.category === category ? 'checked' : '' %>
                                    onchange="document.getElementById('filterForm').submit()">
                                <label for="cat-<%= category %>"><%= category %></label>
                            </div>
                        <% }) %>
                    </div>
                </div>
                
                <% if(subcategories && subcategories.length > 0) { %>
                <div class="filter-section">
                    <h3><i class="fas fa-tags"></i> Phụ mục</h3>
                    <div class="filter-options">
                        <% subcategories.forEach(subcategory => { %>
                            <div class="filter-option">
                                <input type="checkbox" name="subcategory" id="subcat-<%= subcategory %>" 
                                    value="<%= subcategory %>" 
                                    <%= filter.subcategory === subcategory ? 'checked' : '' %>
                                    onchange="document.getElementById('filterForm').submit()">
                                <label for="subcat-<%= subcategory %>"><%= subcategory %></label>
                            </div>
                        <% }) %>
                    </div>
                </div>
                <% } %>
                
                <div class="filter-section">
                    <h3><i class="fas fa-building"></i> Thương hiệu</h3>
                    <div class="filter-options">
                        <% brands.forEach(brand => { %>
                            <div class="filter-option">
                                <input type="checkbox" name="brand" id="brand-<%= brand %>" 
                                    value="<%= brand %>" 
                                    <%= (Array.isArray(filter.brand) && filter.brand.includes(brand)) || filter.brand === brand ? 'checked' : '' %>
                                    onchange="document.getElementById('filterForm').submit()">
                                <label for="brand-<%= brand %>"><%= brand %></label>
                            </div>
                        <% }) %>
                    </div>
                </div>
                
                <div class="filter-section">
                    <h3><i class="fas fa-dollar-sign"></i> Giá (VNĐ)</h3>
                    <div class="price-filter">
                        <input type="number" name="minPrice" placeholder="Giá thấp nhất" 
                               value="<%= filter.minPrice || '' %>" min="0" step="100000">
                        <span>đến</span>
                        <input type="number" name="maxPrice" placeholder="Giá cao nhất" 
                               value="<%= filter.maxPrice || '' %>" min="0" step="100000">
                        <button type="submit" class="btn btn-sm btn-primary">Áp dụng</button>
                    </div>
                </div>
                
                <!-- Rating Filter -->
                <div class="filter-section">
                    <h3><i class="fas fa-star"></i> Đánh giá</h3>
                    <div class="rating-filter">
                        <% for (let r = 5; r >= 1; r--) { %>
                        <label class="rating-option">
                            <input type="radio" name="rating" value="<%= r %>" 
                                   <%= filter.rating == r ? 'checked' : '' %>
                                   onchange="document.getElementById('filterForm').submit()">
                            <span class="stars">
                                <% for (let s = 1; s <= 5; s++) { %>
                                    <i class="<%= s <= r ? 'fas' : 'far' %> fa-star"></i>
                                <% } %>
                            </span>
                            <span><%= r %> sao trở lên</span>
                        </label>
                        <% } %>
                    </div>
                </div>
                
                <!-- Stock Filter -->
                <div class="filter-section">
                    <h3><i class="fas fa-box"></i> Tình trạng</h3>
                    <div class="stock-filter">
                        <label class="stock-option <%= !filter.stock || filter.stock === 'all' ? 'active' : '' %>">
                            <input type="radio" name="stock" value="" 
                                   <%= !filter.stock ? 'checked' : '' %>
                                   onchange="document.getElementById('filterForm').submit()">
                            <span>Tất cả</span>
                        </label>
                        <label class="stock-option <%= filter.stock === 'in-stock' ? 'active' : '' %>">
                            <input type="radio" name="stock" value="in-stock" 
                                   <%= filter.stock === 'in-stock' ? 'checked' : '' %>
                                   onchange="document.getElementById('filterForm').submit()">
                            <span><i class="fas fa-check-circle text-success"></i> Còn hàng</span>
                        </label>
                        <label class="stock-option <%= filter.stock === 'out-of-stock' ? 'active' : '' %>">
                            <input type="radio" name="stock" value="out-of-stock" 
                                   <%= filter.stock === 'out-of-stock' ? 'checked' : '' %>
                                   onchange="document.getElementById('filterForm').submit()">
                            <span><i class="fas fa-times-circle text-danger"></i> Hết hàng</span>
                        </label>
                        <label class="stock-option <%= filter.stock === 'pre-order' ? 'active' : '' %>">
                            <input type="radio" name="stock" value="pre-order" 
                                   <%= filter.stock === 'pre-order' ? 'checked' : '' %>
                                   onchange="document.getElementById('filterForm').submit()">
                            <span><i class="fas fa-clock text-warning"></i> Đặt trước</span>
                        </label>
                    </div>
                </div>
                
                <!-- Discount Filter -->
                <div class="filter-section">
                    <h3><i class="fas fa-percent"></i> Khuyến mãi</h3>
                    <div class="discount-filter">
                        <label class="discount-option <%= !filter.discount || filter.discount === 'all' ? 'active' : '' %>">
                            <input type="radio" name="discount" value="" 
                                   <%= !filter.discount ? 'checked' : '' %>
                                   onchange="document.getElementById('filterForm').submit()">
                            <span>Tất cả</span>
                        </label>
                        <label class="discount-option has-discount <%= filter.discount === 'has-discount' ? 'active' : '' %>">
                            <input type="radio" name="discount" value="has-discount" 
                                   <%= filter.discount === 'has-discount' ? 'checked' : '' %>
                                   onchange="document.getElementById('filterForm').submit()">
                            <span><i class="fas fa-fire"></i> Đang giảm giá</span>
                        </label>
                    </div>
                </div>
                
                <div class="filter-section">
                    <button type="button" class="btn btn-outline-danger w-100" id="clearFilters">
                        <i class="fas fa-times"></i> Xóa bộ lọc
                    </button>
                </div>
            </form>
        </div>
        
        <!-- Product grid and sorting options -->
        <div class="product-content">
            <div class="product-sorting">
                <div class="sort-options">
                    <span>Sắp xếp theo:</span>
                    <select id="sortSelect" onchange="sortProducts(this.value)">
                        <option value="newest" <%= filter.sort === 'newest' || !filter.sort ? 'selected' : '' %>>Mới nhất</option>
                        <option value="price-asc" <%= filter.sort === 'price-asc' ? 'selected' : '' %>>Giá tăng dần</option>
                        <option value="price-desc" <%= filter.sort === 'price-desc' ? 'selected' : '' %>>Giá giảm dần</option>
                        <option value="name-asc" <%= filter.sort === 'name-asc' ? 'selected' : '' %>>Tên A-Z</option>
                        <option value="name-desc" <%= filter.sort === 'name-desc' ? 'selected' : '' %>>Tên Z-A</option>
                        <option value="rating-desc" <%= filter.sort === 'rating-desc' ? 'selected' : '' %>>Đánh giá cao nhất</option>
                        <option value="bestseller" <%= filter.sort === 'bestseller' ? 'selected' : '' %>>Bán chạy nhất</option>
                        <option value="discount" <%= filter.sort === 'discount' ? 'selected' : '' %>>Giảm giá nhiều nhất</option>
                    </select>
                </div>
                
                <div class="view-options">
                    <button class="btn btn-sm btn-outline-secondary view-btn grid-view active" data-view="grid">
                        <i class="fas fa-th"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary view-btn list-view" data-view="list">
                        <i class="fas fa-list"></i>
                    </button>
                </div>
            </div>
            
            <% if (products.length > 0) { %>
                <div class="products grid-view-active" id="productContainer">
                    <% products.forEach(product => { %>
                        <div class="product-item">
                            <div class="product-card">
                                <a href="/products/<%= product.slug %>">
                                    <div class="image">
                                        <% if (product.images && product.images.length > 0) { %>
                                            <img src="/uploads/products/<%= product.images[0] %>" alt="<%= product.name %>">
                                        <% } else { %>
                                            <img src="/images/no-image.png" alt="No Image Available">
                                        <% } %>
                                    </div>
                                    
                                    <div class="content">
                                        <h3><%= product.name %></h3>
                                        
                                        <div class="price">
                                            <% if (product.discountPrice) { %>
                                                <span class="discount-price"><%= product.discountPrice.toLocaleString('vi-VN') %> ₫</span>
                                                <span class="original-price"><%= product.price.toLocaleString('vi-VN') %> ₫</span>
                                            <% } else { %>
                                                <%= product.price.toLocaleString('vi-VN') %> ₫
                                            <% } %>
                                        </div>
                                        
                                        <div class="rating">
                                            <% for (let i = 1; i <= 5; i++) { %>
                                                <% if (i <= Math.round(product.averageRating)) { %>
                                                    <i class="fas fa-star"></i>
                                                <% } else { %>
                                                    <i class="far fa-star"></i>
                                                <% } %>
                                            <% } %>
                                            (<%= product.ratings.length %>)
                                        </div>
                                        
                                        <div class="description">
                                            <%= product.description.substring(0, 150) %>...
                                        </div>
                                        
                                        <div class="actions">
                                            <button class="btn btn-primary add-to-cart" data-id="<%= product._id %>">
                                                <i class="fas fa-shopping-cart"></i> Thêm vào giỏ
                                            </button>
                                            <a href="/products/<%= product.slug %>" class="btn btn-outline-primary">
                                                Chi tiết
                                            </a>
                                        </div>
                                    </div>
                                </a>
                            </div>
                        </div>
                    <% }) %>
                </div>
                
                <!-- Pagination -->
                <% if (totalPages > 0) { %>
                    <div class="pagination-container">
                        <ul class="pagination">
                            <% if (currentPage > 1) { %>
                                <li class="page-item">
                                    <a class="page-link" href="<%= getPaginationUrl(1) %>">Đầu</a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="<%= getPaginationUrl(currentPage - 1) %>">Trước</a>
                                </li>
                            <% } %>
                            
                            <% 
                            let startPage = Math.max(1, currentPage - 2);
                            let endPage = Math.min(totalPages, startPage + 4);
                            if (endPage - startPage < 4 && startPage > 1) {
                                startPage = Math.max(1, endPage - 4);
                            }
                            %>
                            
                            <% for (let i = startPage; i <= endPage; i++) { %>
                                <li class="page-item <%= i === currentPage ? 'active' : '' %>">
                                    <a class="page-link" href="<%= getPaginationUrl(i) %>"><%= i %></a>
                                </li>
                            <% } %>
                            
                            <% if (currentPage < totalPages) { %>
                                <li class="page-item">
                                    <a class="page-link" href="<%= getPaginationUrl(currentPage + 1) %>">Tiếp</a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="<%= getPaginationUrl(totalPages) %>">Cuối</a>
                                </li>
                            <% } %>
                        </ul>
                    </div>
                <% } %>
            <% } else { %>
                <div class="no-products">
                    <p>Không tìm thấy sản phẩm nào phù hợp với tiêu chí tìm kiếm.</p>
                </div>
            <% } %>
        </div>
    </div>
</div>

<script>
    // Function to build pagination URL
    function getPaginationUrl(page) {
        const url = new URL(window.location.href);
        url.searchParams.set('page', page);
        return url.search;
    }
    
    // Function to handle sorting
    function sortProducts(sortValue) {
        const url = new URL(window.location.href);
        url.searchParams.set('sort', sortValue);
        url.searchParams.delete('page'); // Reset to page 1 when sorting changes
        window.location.href = url.href;
    }
    
    // Function to handle view switching (grid/list)
    document.addEventListener('DOMContentLoaded', function() {
        const viewButtons = document.querySelectorAll('.view-btn');
        const productContainer = document.getElementById('productContainer');
        
        viewButtons.forEach(button => {
            button.addEventListener('click', function() {
                const view = this.dataset.view;
                
                // Update buttons
                viewButtons.forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                
                // Update view
                if (view === 'grid') {
                    productContainer.classList.add('grid-view-active');
                    productContainer.classList.remove('list-view-active');
                } else {
                    productContainer.classList.add('list-view-active');
                    productContainer.classList.remove('grid-view-active');
                }
            });
        });
        
        // Clear all filters
        document.getElementById('clearFilters').addEventListener('click', function() {
            window.location.href = '/products';
        });
        
        // Remove individual filter
        document.querySelectorAll('.remove-filter').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                const tag = this.closest('.active-filter-tag');
                const type = tag.dataset.type;
                const value = tag.dataset.value;
                const url = new URL(window.location.href);
                
                switch(type) {
                    case 'search':
                        url.searchParams.delete('search');
                        break;
                    case 'category':
                        url.searchParams.delete('category');
                        url.searchParams.delete('subcategory');
                        break;
                    case 'subcategory':
                        url.searchParams.delete('subcategory');
                        break;
                    case 'brand':
                        // Handle multiple brands
                        const brands = url.searchParams.getAll('brand');
                        url.searchParams.delete('brand');
                        brands.filter(b => b !== value).forEach(b => url.searchParams.append('brand', b));
                        break;
                    case 'price':
                        url.searchParams.delete('minPrice');
                        url.searchParams.delete('maxPrice');
                        break;
                    case 'rating':
                        url.searchParams.delete('rating');
                        break;
                    case 'stock':
                        url.searchParams.delete('stock');
                        break;
                    case 'discount':
                        url.searchParams.delete('discount');
                        break;
                }
                
                url.searchParams.delete('page');
                window.location.href = url.href;
            });
        });
        
        // Mobile filter toggle
        const mobileFilterBtn = document.getElementById('mobileFilterBtn');
        const filtersSidebar = document.getElementById('filtersSidebar');
        
        if (mobileFilterBtn && filtersSidebar) {
            mobileFilterBtn.addEventListener('click', function() {
                filtersSidebar.classList.toggle('mobile-open');
                document.body.classList.toggle('filter-open');
            });
            
            // Close filter on overlay click (mobile)
            filtersSidebar.addEventListener('click', function(e) {
                if (e.target === filtersSidebar) {
                    filtersSidebar.classList.remove('mobile-open');
                    document.body.classList.remove('filter-open');
                }
            });
        }
    });
</script>
